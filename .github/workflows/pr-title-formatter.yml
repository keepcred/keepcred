name: 'Auto PR Title'

on:
  pull_request:
    types: [opened, reopened]

permissions:
  pull-requests: write
  issues: read

jobs:
  update_pr_title:
    runs-on: ubuntu-latest
    steps:
      - name: Update PR Title with Emoji and Ticket
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const branchName = pr.head.ref;
            const regex = /^(feat|fix|chore|docs|style|refactor|perf|test)\/(\d+)[-_\/](.+)$/;
            const match = branchName.match(regex);

            if (!match) {
              console.log('–ò–º—è –≤–µ—Ç–∫–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É "type/number-text".');
              return;
            }

            const type = match[1];
            const issueNumber = match[2];

            let description = match[3].replace(/-/g, ' ');

            try {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              if (issue.data && issue.data.title) {
                description = issue.data.title;
                console.log(`–ù–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏: ${description}`);
              }
            } catch (error) {
              console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∏–º—è –∏–∑ –≤–µ—Ç–∫–∏.');
            }

            const typeToEmoji = {
              feat: '‚ú®',
              fix: 'ü©π',
              chore: '‚öôÔ∏è',
              docs: 'üìÉ',
              style: 'üíÑ',
              refactor: 'üßπ',
              perf: 'üöÄ',
              test: 'üß™'
            };

            const emoji = typeToEmoji[type] || '‚ùî';
            const newTitle = `#${issueNumber} ${emoji} ${type}: ${description}`;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              title: newTitle
            });
